name: Windows RDP via Tailscale (B)

on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["Windows RDP via Tailscale (A)"]
    types: [completed]

# Prevent overlapping copies of this loop from running at the same time
concurrency:
  group: rdp-loop
  cancel-in-progress: true

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360        # ~6h GitHub cap
    env:
      FIXED_HOSTNAME: gha-rdp   # same hostname so Tailscale reuses/renames the device
      RDP_USER: hxhz12
      RDP_PASSWORD: qw123456@.Q
      TAILSCALE_AUTH_KEY: tskey-auth-k4CCYdgnHD21CNTRL-B8y8pXZJK9bWLDZDa1X3AbRbVWqojvhkK
    steps:
      - name: Install Tailscale
        shell: pwsh
        run: |
          $msi  = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /qn /norestart" -Wait
          Remove-Item $msi -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" version

      - name: Enable RDP + user + firewall
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Set-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          $sec = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          if (-not (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $env:RDP_USER -Password $sec -AccountNeverExpires
          } else {
            Set-LocalUser -Name $env:RDP_USER -Password $sec -AccountNeverExpires:$true
            Enable-LocalUser -Name $env:RDP_USER
          }
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER -ErrorAction SilentlyContinue

      - name: Tailscale up (fixed hostname)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $ts up --authkey "$env:TAILSCALE_AUTH_KEY" --hostname "$env:FIXED_HOSTNAME" --reset
          if ($LASTEXITCODE -ne 0) { throw "tailscale up failed" }

          $ip4 = & $ts ip -4
          $ip6 = & $ts ip -6

          Write-Host "================ RDP CONNECT ================"
          Write-Host "MagicDNS name : $env:FIXED_HOSTNAME"
          Write-Host "IPv4          : $ip4"
          Write-Host "IPv6          : $ip6"
          Write-Host "mstsc         : mstsc /v:$($env:FIXED_HOSTNAME)"
          Write-Host "Username      : $env:RDP_USER"
          Write-Host "Password      : $env:RDP_PASSWORD"
          Write-Host "============================================"

      - name: Keep alive (~5h 50m)
        shell: pwsh
        run: |
          $until = (Get-Date).AddMinutes(350)
          while ((Get-Date) -lt $until) {
            Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] RDP aliveâ€¦"
            Start-Sleep -Seconds 300
          }
